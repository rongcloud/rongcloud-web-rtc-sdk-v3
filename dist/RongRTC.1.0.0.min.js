/*
* RongRTC.js v1.0.0
* Copyright 2018 RongCloud
* Released under the MIT License.
*/(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.RongRTC=t()})(this,function(){"use strict";function e(){return{join:function(){},leave:function(){},_on:function(){}}}function t(){return{disable:function(){},enable:function(){}}}function n(){return{mute:function(){},unmute:function(){}}}function r(e){var r=t(e),a=n(e);return{$video:r,$audio:a,get:function(e){console.log(e)}}}function a(){return{create:function(){},remove:function(){},get:function(){},getList:function(){}}}function o(){return{start:function(){},stop:function(){}}}var s,d=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},l=function(){function e(e,t){for(var n,r=0;r<t.length;r++)n=t[r],n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),p=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},c=function(){function e(){d(this,e)}return l(e,null,[{key:"extend",value:function(e,t){for(var n in t){var r=t[n];e[n]=r}return e}},{key:"noop",value:function(){}},{key:"deferred",value:function(e){return new Promise(e)}}]),e}(),g={/** 带宽设置计数器 */bandWidthCount:0/** ----- 参数定义 ----- */ /** ----- 常量定义 ----- */},u={/** RongRTC SDK版本号 */SDK_VERSION_NAME:"1.6.0",/** logon version */LOGON_VERSION:"1",/** keepAlive时间间隔 */KEEPALIVE_INTERVAL:5000,/** keepAlive最大连续失败次数 */KEEPALIVE_FAILEDTIMES_MAX:4,/** keepAliveTimer时间间隔 */KEEPALIVE_TIMER_INTERVAL:1000,/** keepAlive未收到result最大超时时间 */KEEPALIVE_TIMER_TIMEOUT_MAX:20,/** keepAlive未收到result最大超时时间 */KEEPALIVE_TIMER_TIMEOUT_RECONNECT:12,/** reconnect最大连续次数 */RECONNECT_MAXTIMES:10,/** reconnect连续重连时间间隔 */RECONNECT_TIMEOUT:1000,/** getStatsReport时间间隔 */GETSTATSREPORT_INTERVAL:1000/** 连接类型 */};u.ConnectionType={/** P2P模式 */P2P:"0",/** MediaServer模式 */MEDIASERVER:"1"/** 用户模式类型 */},u.UserType={/** 普通模式 */NORMAL:"1",/** 观察者模式 */OBSERVER:"2"/** 与服务器的连接状态 */},u.ConnectionState={CONNECTED:"CONNECTED",DISCONNECTED:"DISCONNECTED",ROOM_ERROR:"ROOM_ERROR"/** websocket的连接状态 */},u.wsConnectionState={CONNECTED:"CONNECTED",DISCONNECTED:"DISCONNECTED",CONNECTING:"CONNECTING"/** 交换类型 */},u.ExchangeType={/** offer */OFFER:"1",/** answer */ANSWER:"2",/** candidate */CANDIDATE:"3"/** logonAndJoin status */},u.LogonAndJoinStatus={CONNECT:0,RECONNECT:1/** offer status */},u.OfferStatus={SENDING:"SENDING",DONE:"DONE"/**
    * 会控
    */},u.Meeting={RoleChange:{DEMOTION:1,INVITE:2,REMOVE:3},ChannelAnswer:{INVITE_OBSERVER:1,OBSERVER_SPEAK:2,INVITE_OPEN_DEV:3,DEMOTIONUSER:4,INVITE_CLOSE_DEV:5/** 信令 */}},u.SignalType=(s={/** 请求信令 */ // LOGON : 'logon',
// JOIN : 'join',
// PING : 'ping',
LOGONANDJOIN:"logonAndJoin",CHANNEL_PING:"channelPing",UPDATETALKTYPE:"updateTalkType",LEAVE:"leave",EWB_CREATE:"ewb_create",EWB_QUERY:"ewb_query",/** 应答信令 */LOGONANDJOIN_RESULT:"logonAndJoin_result",CHANNEL_PING_RESULT:"channelPing_result",LEAVE_RESULT:"leave_result",EWB_CREATE_RESULT:"ewb_create_result",EWB_QUERY_RESULT:"ewb_query_result",/** 通知信令 */JOINED:"joined",UPDATE_TALKTYPE:"update_talktype",OFFER_REQUEST:"offerRequest",LEFT:"left",EWB_CREATE_NOTIFY:"ewb_create_notify",FLOWSUBSCRIBE:"flowSubscribe",//本地大小流切换 通知服务器
/** exchange信令 */EXCHANGE:"exchange"},p(s,"EWB_CREATE_NOTIFY","ewb_create_notify"),p(s,"ROLECHANGE","rolechange"),p(s,"ROLECHANGE_RESULT","rolechange_result"),p(s,"APPLY","apply"),p(s,"APPLY_RESULT","apply_result"),p(s,"MANAGEACTION","manageaction"),p(s,"MANAGEACTION_RESULT","manageaction_result"),p(s,"CHANNELANSWER","channelanswer"),p(s,"CHANNELANSWER_RESULT","channelanswer_result"),p(s,"CREATENOTIFY","createnotify"),p(s,"CREATENOTIFY_RESULT","createnotify_result"),p(s,"EWBService","ewbservice"),p(s,"SCREENSHARING","screensharing"),p(s,"TURNTALKTYPE","turntalktype"),p(s,"TURNTALKTYPE_RESULT","turntalktype_result"),s),u.VideoProfile_default={width:640,height:480,frameRate:15/** 小视频分辨率 */},u.VideoProfile_min={width:176,height:144,frameRate:15/** 共享屏幕分辨率 */},u.ShareProfile_default={width:1280,height:720,frameRate:15/** 带宽 */},u.BandWidth_default={min:100,max:500/** 带宽全部 */},u.BandWidth_320_240={min:100,max:320},u.BandWidth_640_480={min:100,max:500},u.BandWidth_1280_720={min:100,max:1500},u.BandWidth_ScreenShare_1280_720={min:1e3,max:1500/** ----- 常量定义 ----- */ /** ----- RongRTCEngine ----- */ //var RongRTCEngine = (function() {
/**
    * 构造函数
    *
    */};var S,m,E=function(e){return this.init(e),this.initShare(),this.rongRTCMeeting=new h,m=S=this,this};E.prototype.initShare=function(){// 绑定插件监听事件
// 检测插件
this.addEventListener(),setTimeout(function(){window.postMessage("test","*")},1e3)},E.prototype.init=function(e){/** 会议ID */ /** 连接集合 */ /** 本地视频流 */ /** 远端视频流数组 */ /** 屏幕共享音频流*/ /** logonAndJoin status 登录类型，第一次登录加入房间传0，断线重连传1 */ /** offer status */ /** 连接的用户集合 */ /** remote cname Map */ /** remote Sdp Map */ /** 麦克风开关 */ /** 本地视频开关 */ /** 远端音频开关 */ /** keepAlive连续失败次数计数器 */ /** keepAlive间隔 */ /** keepAlive未收到result计时 */ /** keepAlive未收到result计时器 */ /** reconnect连续次数计数器 */ /** csequence */ /** websocket对象 */ /** websocket消息队列 */ /** websocket连接状态, true:已连接, false:未连接 */ /** websocket是否强制关闭：true:是, false不是 */ /** websocket是否需要重连：true:是, false不是 */ /** websocket地址列表 */ /** websocket地址索引 */ // 设置websocket nav url
/** 视频参数默认值 */ /** media config */ /** 白板 */ //	/** sdp属性 */
//	// 统一设置，包含观察者模式和普通模式无摄像头情况
//	this.mediaConfig.sdpConstraints = {};
//	this.mediaConfig.sdpConstraints.mandatory = {};
//	this.mediaConfig.sdpConstraints.mandatory.OfferToReceiveAudio = true;
//	this.mediaConfig.sdpConstraints.mandatory.OfferToReceiveVideo = true;
/** 是否上报丢包率信息 */ /** RongRTCConnectionStatsReport */ /** getStatsReport间隔 */ /** 是否支持屏幕共享 */this.channelId=null,this.peerConnections={},this.localStream=null,this.remoteStreams=[],this.localAudioStream=null,this.logonAndJoinStatus=null,this.offerStatus=null,this.joinedUsers=new L,this.remoteCnameMap=new L,this.remoteSdpMap=new L,this.microphoneEnable=!0,this.localVideoEnable=!0,this.remoteAudioEnable=!0,this.keepAliveFailedTimes=0,this.keepAliveInterval=null,this.keepAliveTimerCount=0,this.keepAliveTimer=null,this.reconnectTimes=0,this.csequence=0,this.signaling=null,this.wsQueue=[],this.wsConnectionState=null,this.wsForcedClose=!1,this.wsNeedConnect=!0,this.wsUrlList=[],this.wsUrlIndex=0,this.wsNavUrl=e,this.userType=u.UserType.NORMAL,this.isAudioOnly=!1,this.localVideoEnable=!0,this.videoProfile=u.VideoProfile_default,this.videoMinProfile=u.VideoProfile_min,this.videoMaxRate=u.BandWidth_default.max,this.videoMinRate=u.BandWidth_default.min,this.mediaConfig={video:this.videoProfile,audio:!0/** mediaMin config */},this.mediaMinConfig={video:this.videoMinProfile,audio:!1//小流不需要视频
/** bandwidth */},this.bandWidth={min:this.videoMinRate,max:this.videoMaxRate},this.ewbCreated=!1,this.isSendLostReport=!1,this.rongRTCConnectionStatsReport=null,this.getStatsReportInterval=null,this.isScreenShareSupport=!1},E.prototype.reset=function(){},E.prototype.clear=function(){this.exitScheduleKeepAlive(),this.exitScheduleKeepAliveTimer(),this.disconnect(!1),this.closePeerConnection(this.selfUserId)},E.prototype.getSDKVersion=function(){return u.SDK_VERSION_NAME},E.prototype.setRongRTCEngineEventHandle=function(e){this.rongRTCEngineEventHandle=e},E.prototype.setVideoParameters=function(e){/** bandwidth */if(null!=e.USER_TYPE&&e.USER_TYPE==u.UserType.OBSERVER&&(this.userType=u.UserType.OBSERVER),null!=e.IS_AUDIO_ONLY&&(this.isAudioOnly=e.IS_AUDIO_ONLY),null!=e.IS_CLOSE_VIDEO&&(this.localVideoEnable=!e.IS_CLOSE_VIDEO),null!=e.VIDEO_PROFILE&&(this.videoProfile=e.VIDEO_PROFILE,this.mediaConfig.video=this.videoProfile),null!=e.VIDEO_MAX_RATE)this.videoMaxRate=e.VIDEO_MAX_RATE,this.bandWidth.max=this.videoMaxRate;else if(null!=e.VIDEO_PROFILE.width&&null!=e.VIDEO_PROFILE.height){var t=u["BandWidth_"+e.VIDEO_PROFILE.width+"_"+e.VIDEO_PROFILE.height];null!=t&&(this.videoMaxRate=t.max,this.bandWidth.max=this.videoMaxRate)}if(null!=e.VIDEO_MIN_RATE)this.videoMinRate=e.VIDEO_MIN_RATE,this.bandWidth.min=this.videoMinRate;else if(null!=e.VIDEO_PROFILE.width&&null!=e.VIDEO_PROFILE.height){var t=u["BandWidth_"+e.VIDEO_PROFILE.width+"_"+e.VIDEO_PROFILE.height];null!=t&&(this.videoMinRate=t.min,this.bandWidth.min=this.videoMinRate)}//	/** sdp属性 */
//	if (this.userType == RongRTCConstant.UserType.OBSERVER) { // 观察者模式
//		if (this.mediaConfig.sdpConstraints == null) {
//			this.mediaConfig.sdpConstraints = {};
//		}
//		if (this.mediaConfig.sdpConstraints.mandatory == null) {
//			this.mediaConfig.sdpConstraints.mandatory = {};
//		}
//		this.mediaConfig.sdpConstraints.mandatory.OfferToReceiveAudio = true;
//		this.mediaConfig.sdpConstraints.mandatory.OfferToReceiveVideo = true;
//	}
},E.prototype.joinChannel=function(e,t,n){this.channelId=u.ConnectionType.MEDIASERVER+e,this.selfUserId=t,this.token=n;// 创建本地视频    pc.addStream(rongRTCEngine.localStreamMin);//加入小流
var r=this;return 2==r.userType?(r.createSignaling(),r.logonAndJoin(u.LogonAndJoinStatus.CONNECT),void(this.localStream=new MediaStream)):void navigator.getUserMedia(r.mediaConfig,function(e){// 创建websocket连接
_.info("navigator.getUserMedia success"),r.localStream=e,S.localStream.id=S.selfUserId,r.localVideoEnable||r.closeLocalVideoWithUpdateTalkType(!r.localVideoEnable,!1),r.createSignaling(),r.logonAndJoin(u.LogonAndJoinStatus.CONNECT)},function(e){_.error("navigator.getUserMedia error: ",e)})},E.prototype.leaveChannel=function(){this.leave()},E.prototype.getLocalVideoView=function(){return this.getLocalStream()},E.prototype.getRemoteVideoView=function(e){return this.getRemoteStream(e)},E.prototype.getLocalStream=function(){return this.localStream},E.prototype.getRemoteStream=function(e){for(var t in this.remoteStreams)if(this.remoteStreams[t].id==e){return this.remoteStreams[t]}return null},E.prototype.getRemoteStreamCount=function(){return this.remoteStreams.length},E.prototype.createVideoView=function(){var e=document.createElement("video");// 视频自动播放
// isa
return e.autoplay=!0,e.setAttribute("playsinline",!0),e},E.prototype.createLocalVideoView=function(){var e=this.createVideoView();// 本地视频静音
return e.muted=!0,e.id=this.selfUserId,e.srcObject=this.getLocalStream(),e},E.prototype.createRemoteVideoView=function(e){var t=this.getRemoteStream(e),n=this.createVideoView();// if (remoteStream == null) {
// 	return null;
// }
return n.id=e,n.srcObject=t,n},E.prototype.muteMicrophone=function(e){this.updateTalkTypeMic(e)},E.prototype.closeLocalVideo=function(e){this.updateTalkTypeCamera(e)},E.prototype.closeLocalVideoWithUpdateTalkType=function(e){this.localStream&&this.localStream.getVideoTracks().forEach(function(t){t.enabled=!e}),_.info("Local video close="+e),this.localVideoEnable=!e},E.prototype.closeRemoteAudio=function(e){if(0===this.remoteStreams.length)return void _.info("No remote audio available.");for(x=0;x<this.remoteStreams.length;x++){var t=this.remoteStreams[x];if(t&&t.getAudioTracks()&&0<t.getAudioTracks().length)for(y=0;y<t.getAudioTracks().length;y++)t.getAudioTracks()[y].enabled=!e}_.info("Remote audio close="+e),this.remoteAudioEnable=!e},E.prototype.closeLocalStream=function(){if(null==this.localStream||null==this.localStream.getTracks()||0===this.localStream.getTracks().length)_.info("No local track available.");else for(i=0;i<this.localStream.getTracks().length;i++)this.localStream.getTracks()[i].stop();if(this.minStream)// 小流
if(null==this.localStreamMin||null==this.localStreamMin.getTracks()||0===this.localStreamMin.getTracks().length)_.info("No MinStream track available.");else for(i=0;i<this.localStreamMin.getTracks().length;i++)this.localStreamMin.getTracks()[i].stop()},E.prototype.requestWhiteBoardURL=function(){this.ewb_create()},E.prototype.queryWhiteBoard=function(){this.ewb_query()},E.prototype.enableSendLostReport=function(e){this.isSendLostReport=e},E.prototype.checkSupportScreen=function(){// 检测浏览器是否支持
var e=N.myBrowser();if(0>["Chrome"].indexOf(e))return void this.rongRTCEngineEventHandle.call("onStartScreenShareComplete",{isSuccess:!1,code:1// 浏览器不支持
});var t=this;if(!t.isScreenShareSupport)return void t.rongRTCEngineEventHandle.call("onStartScreenShareComplete",{isSuccess:!1,code:2// 未安装插件
})},E.prototype._startScreenShare=function(e){this.checkSupportScreen(),e?this.shareWithStream(e):m.requestScreenShare()},E.prototype.startScreenShare=function(e){this._startScreenShare(e)},E.prototype.stopScreenShare=function(){this.endShareScreen()},E.prototype.endShareScreen=function(){this.rongRTCMeeting.screenShare(!1);var e=this;e.getLocalStreamFromRtcApi(e.mediaConfig).then(function(t){e.localAudioStream?e.localAudioStream.getTracks().forEach(function(e){e.stop()}):void 0,t.getAudioTracks().forEach(function(t){t.enabled=e.microphoneEnable}),m.screenSharingStatus=!1,N.setMediaStream(e.selfUserId,t),e.screenOffer(t);// talktype[0:无视频有音频, 1:有视频有音频, 2:有视频无音频, 3:无视频无音频]
var n;n=!e.localVideoEnable&&e.microphoneEnable?0:e.localVideoEnable&&e.microphoneEnable?1:e.localVideoEnable&&!e.microphoneEnable?2:3,S.rongRTCEngineEventHandle.call("onShareComplete",{isShared:!1,stream:S.localStream,userId:S.selfUserId,talkType:n}),m.rongRTCEngineEventHandle.call("onStopScreenShareComplete",{isSuccess:!0,isShared:!1,stream:S.localStream,userId:S.selfUserId})}).catch(function(e){_.error("stopScreenShare getLocalStreamFromRtcApi error: "+e),m.rongRTCEngineEventHandle.call("onStopScreenShareComplete",{isSuccess:!1})})},E.prototype.createSignaling=function(){if(this.wsConnectionState=u.wsConnectionState.CONNECTING,0<this.wsUrlList.length){this.wsUrlIndex++,this.wsUrlIndex>this.wsUrlList.length-1&&(this.wsUrlIndex=0);var e=this.wsUrlList[this.wsUrlIndex];this.createSignalingWithUrl(e)}else{// 还没有取得websocket连接地址
var t=this;N.getWsUrlList(this.wsNavUrl,function(e){var n=e;if(1>n.length)throw new Error("websocket\u8FDE\u63A5\u5931\u8D25!");t.wsUrlList=N.shuffle(n);var r=t.wsUrlList[0];t.createSignalingWithUrl(r)})}},E.prototype.createSignalingWithUrl=function(e){var t=this;t.signaling=new WebSocket("wss://"+e+"/signaling"),t.signaling.onopen=function(){t.onOpen()},t.signaling.onmessage=function(e){t.onMessage(e)},t.signaling.onerror=function(e){t.onError(e)},t.signaling.onclose=function(e){t.onClose(e)}};/**
  * RongRTCMessage实体
  *
  * @param signal
  * @param content
  * @param parameters
  * @returns
  */var f=function(e,t,n){this.signal=e,this.content=t,this.parameters=n};/**
  * 发送消息
  *
  */E.prototype.sendMsg=function(e,t,n){this.csequence++,n.csequence=this.csequence;var r=JSON.stringify(new f(e,t,n));this.send(r)},E.prototype.send=function(e){var t=JSON.parse(e).signal;this.wsConnectionState==u.wsConnectionState.CONNECTED?(t==u.SignalType.CHANNEL_PING?_.debug("req: "+e):_.info("req: "+e),this.signaling.send(e)):(_.warn("websocket not connected!"),0==this.wsQueue.length// 消息队列只保留一条logonAndJoin
&&t==u.SignalType.LOGONANDJOIN&&this.wsQueue.push(e))},E.prototype.doWsQueue=function(){if(0<this.wsQueue.length){// 消息队列只有一条logonAndJoin，取出并删除
var e=this.wsQueue.shift();this.send(e)}},E.prototype.onOpen=function(){// ws连接可用
// 重置reconnectTimes
// websocket可用后，发送队列中的消息
_.info("websocket open"),this.wsConnectionState=u.wsConnectionState.CONNECTED,this.reconnectTimes=0,this.doWsQueue()},E.prototype.onMessage=function(e){var t=JSON.parse(e.data);switch(t.signal==u.SignalType.CHANNEL_PING_RESULT?_.debug("res: "+e.data):_.info("res: "+e.data),t.signal){// 应答信令
case u.SignalType.LOGONANDJOIN_RESULT:return void this.logonAndJoin_result(t);case u.SignalType.CHANNEL_PING_RESULT:return void this.channelPing_result(t);case u.SignalType.LEAVE_RESULT:return void this.leave_result(t);case u.SignalType.EWB_CREATE_RESULT:return void this.ewb_create_result(t);case u.SignalType.EWB_QUERY_RESULT:return void this.ewb_query_result(t);// 通知信令
case u.SignalType.JOINED:return void this.joined(t);case u.SignalType.LEFT:return void this.left(t);case u.SignalType.OFFER_REQUEST:return void this.offerRequest(t);case u.SignalType.UPDATE_TALKTYPE:return void this.update_talktype(t);// exchange信令
case u.SignalType.EXCHANGE:return void this.exchange(t);// exchange信令
case u.SignalType.EWB_CREATE_NOTIFY:return void this.ewbCreateNotify(t);//会控信令 // todo
case u.SignalType.ROLECHANGE:return void this.rongRTCMeeting.roleChange(t);case u.SignalType.APPLY:return void this.rongRTCMeeting.applyMessage(t);case u.SignalType.MANAGEACTION:return void this.rongRTCMeeting.manageAction(t);case u.SignalType.CHANNELANSWER:return void this.rongRTCMeeting.channelAnswer(t);case u.SignalType.CREATENOTIFY:return void console.info(t);case u.SignalType.SCREENSHARING:return void console.info(t);case u.SignalType.TURNTALKTYPE:return void this.rongRTCMeeting.turntalktype(t);default:_.warn("Event "+t.signal+" do not have defined function",t.parameters);}},E.prototype.onClose=function(e){var t=this;_.warn("websocket close",e);1e3==e.code&&"wsForcedClose"==e.reason||(// ws连接不可用
this.wsConnectionState=u.wsConnectionState.DISCONNECTED,this.wsNeedConnect&&setTimeout(function(){t.reconnect()},u.RECONNECT_TIMEOUT))},E.prototype.onError=function(e){_.error("websocket error",e)},E.prototype.disconnect=function(e){// 自定义关闭ws连接
_.warn("websocket disconnect"),_.warn("wsNeedConnect="+e),this.wsForcedClose=!0,this.wsNeedConnect=e,this.wsConnectionState=u.wsConnectionState.DISCONNECTED,this.signaling.close(1e3,"wsForcedClose"),this.wsNeedConnect&&this.reconnect()},E.prototype.reconnect=function(){if(this.wsConnectionState==u.wsConnectionState.DISCONNECTED)// ws连接可用或正在连接不重连
if(this.reconnectTimes++,_.warn("reconnectTimes="+this.reconnectTimes),this.reconnectTimes>u.RECONNECT_MAXTIMES)this.keepAliveDisconnect();else{var e=function(e){e.wsConnectionState==u.wsConnectionState.DISCONNECTED&&(_.info("websocket reconnect"),e.createSignaling(),e.logonAndJoin(u.LogonAndJoinStatus.RECONNECT))},t=this;1<t.reconnectTimes?setTimeout(function(){e(t)},u.RECONNECT_TIMEOUT):e(t)}},E.prototype.keepAlive=function(){this.wsConnectionState==u.wsConnectionState.CONNECTED?(this.startScheduleKeepAliveTimer(),this.channelPing()):this.keepAliveFailed()},E.prototype.keepAliveFailed=function(){this.keepAliveFailedTimes++,_.warn("keepAliveFailedTimes="+this.keepAliveFailedTimes),this.keepAliveFailedTimes>u.KEEPALIVE_FAILEDTIMES_MAX&&this.keepAliveDisconnect()},E.prototype.startScheduleKeepAlive=function(){this.exitScheduleKeepAlive(),this.exitScheduleKeepAliveTimer();var e=this;// 立即执行1次
e.keepAlive(),e.keepAliveInterval=setInterval(function(){e.keepAlive()},u.KEEPALIVE_INTERVAL)},E.prototype.exitScheduleKeepAlive=function(){this.keepAliveFailedTimes=0,null!=this.keepAliveInterval&&(clearInterval(this.keepAliveInterval),this.keepAliveInterval=null)},E.prototype.keepAliveTimerFunc=function(){return this.keepAliveTimerCount++,this.keepAliveTimerCount>u.KEEPALIVE_TIMER_TIMEOUT_MAX/3?_.warn("keepAliveTimerCount="+this.keepAliveTimerCount):_.debug("keepAliveTimerCount="+this.keepAliveTimerCount),this.keepAliveTimerCount>u.KEEPALIVE_TIMER_TIMEOUT_MAX?void this.keepAliveDisconnect():void(this.keepAliveTimerCount==u.KEEPALIVE_TIMER_TIMEOUT_RECONNECT&&this.disconnect(!0))},E.prototype.startScheduleKeepAliveTimer=function(){if(null==this.keepAliveTimer){var e=this;// keepAlive5秒间隔，这个时候有可能已经断了5秒
e.keepAliveTimerCount+=u.KEEPALIVE_INTERVAL/1e3,e.keepAliveTimer=setInterval(function(){e.keepAliveTimerFunc()},u.KEEPALIVE_TIMER_INTERVAL)}},E.prototype.exitScheduleKeepAliveTimer=function(){this.keepAliveTimerCount=0,null!=this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null)},E.prototype.keepAliveDisconnect=function(){this.clear(),this.rongRTCEngineEventHandle.call("onConnectionStateChanged",{connectionState:u.ConnectionState.DISCONNECTED})},E.prototype.getStatsReport=function(){var e=this.peerConnections[this.selfUserId];if(null!=e){var t=e.pc,n=this;t.getStats(null,function(e){n.rongRTCConnectionStatsReport.parseStatsReport(e),n.isSendLostReport&&(_.debug("onNetworkSentLost="+n.rongRTCConnectionStatsReport.packetSendLossRate),n.rongRTCEngineEventHandle.call("onNetworkSentLost",{packetSendLossRate:n.rongRTCConnectionStatsReport.packetSendLossRate}))},function(e){_.error("getStatsReport error: ",e)})}},E.prototype.startScheduleGetStatsReport=function(){this.exitScheduleGetStatsReport(),this.rongRTCConnectionStatsReport=new O;var e=this;e.getStatsReportInterval=setInterval(function(){e.getStatsReport()},u.GETSTATSREPORT_INTERVAL)},E.prototype.exitScheduleGetStatsReport=function(){null!=this.getStatsReportInterval&&(clearInterval(this.getStatsReportInterval),this.getStatsReportInterval=null),this.rongRTCConnectionStatsReport=null},E.prototype.addEventListener=function(){if(!this.isBindEvent)// 已经绑定过事件
{var e=this;window.addEventListener("message",function(t){var n={onResponseReqSouId:function(t){e.getLocalStreamFromRtcApi({video:!1,audio:!0}).then(function(t){e.localAudioStream=t,t.getAudioTracks().forEach(function(t){t.enabled=e.microphoneEnable})}).catch(function(t){_.error("onResponseReqSouId getLocalStreamFromRtcApi error: "+t),e.rongRTCEngineEventHandle.call("onStartScreenShareComplete",{isSuccess:!1})}),e.getScreenStream(t.data.sourceId).then(function(t){t.getVideoTracks()[0].onended=function(){e.endShareScreen()},e.screenShare(t)}).catch(function(t){_.error("onResponseReqSouId getScreenStream error: "+t),e.rongRTCEngineEventHandle.call("onStartScreenShareComplete",{isSuccess:!1})})},testMessage:function(){e.isScreenShareSupport=!0},other:function(e){_.info(e)}},r=n[t.data.type]||n.other;r(t,e)},!1),this.isBindEvent=!0}},E.prototype.requestScreenShare=function(){window.postMessage("requestScreenSourceId","*")},E.prototype.getLocalStreamFromRtcApi=function(e){return new Promise(function(t,n){navigator.getUserMedia(e,t,n)})},E.prototype.getScreenStream=function(e){var t={mandatory:{chromeMediaSource:"desktop",maxWidth:u.ShareProfile_default.width,maxHeight:u.ShareProfile_default.height,chromeMediaSourceId:e},optional:[{googTemporalLayeredScreencast:!0}]};return e=null,new Promise(function(e,n){navigator.getUserMedia({video:t},e,n)})},E.prototype.screenShare=function(e){this.screenSharingStatus=!0,this.screenOffer(e),N.setMediaStream(this.selfUserId,e),this.rongRTCEngineEventHandle.call("onStartScreenShareComplete",{isSuccess:!0})},E.prototype.screenOffer=function(e){var t=this.localStream;this.localStream=e;var n=this.peerConnections[this.selfUserId];if(null!=n){// 只有一人时，值为null
var r=n.pc;this.screenSharingStatus?(r.addStream(this.localAudioStream),this.minStream&&r.removeStream(this.localStreamMin)):(r.removeStream(this.localAudioStream),this.minStream&&r.addStream(this.localStreamMin)),r.removeStream(t),r.addStream(e),_.info("createOfferforShare"),this.createOffer(r,this.selfUserId,!0)}t.getTracks().forEach(function(e){e.stop()}),this.localVideoEnable||this.closeLocalVideoWithUpdateTalkType(!this.localVideoEnable,!1)},E.prototype.logonAndJoin=function(e){this.logonAndJoinStatus=null==e||e==null?0:e,this.offerStatus=null,this.sendMsg(u.SignalType.LOGONANDJOIN,this.token,{key:this.channelId,type:this.userType,index:this.localVideoEnable?1:0,status:this.logonAndJoinStatus,version:u.LOGON_VERSION// , 'mediaid': this.selfUserId // 只在融云RCE环境下开启
})},E.prototype.channelPing=function(){this.sendMsg(u.SignalType.CHANNEL_PING,null,{key:this.channelId})},E.prototype.updateTalkType=function(){this.sendMsg(u.SignalType.UPDATETALKTYPE,null,{key:this.channelId,index:this.localVideoEnable?1:0})},E.prototype.updateTalkTypeCamera=function(e){var t=!0;this.userType==u.UserType.OBSERVER&&(t=!1),this.closeLocalVideoWithUpdateTalkType(e,t),this.sendMsg(u.SignalType.TURNTALKTYPE,null,{key:this.channelId,index:this.localVideoEnable?1:2,type:1})},E.prototype.updateTalkTypeMic=function(e){this.localStream&&this.localStream.getAudioTracks().forEach(function(t){t.enabled=!e}),this.localAudioStream&&this.localAudioStream.getAudioTracks().forEach(function(t){t.enabled=!e}),_.info("Microphone mute="+e),this.microphoneEnable=!e,this.sendMsg(u.SignalType.TURNTALKTYPE,null,{key:this.channelId,index:this.microphoneEnable?1:2,type:2})},E.prototype.leave=function(){this.sendMsg(u.SignalType.LEAVE,null,{key:this.channelId})},E.prototype.offer=function(e,t){this.sendMsg(u.SignalType.EXCHANGE,e,{key:this.channelId,type:u.ExchangeType.OFFER,to:t})},E.prototype.answer=function(e,t){this.sendMsg(u.SignalType.EXCHANGE,e,{key:this.channelId,type:u.ExchangeType.ANSWER,to:t})},E.prototype.candidate=function(e,t){this.sendMsg(u.SignalType.EXCHANGE,e,{key:this.channelId,type:u.ExchangeType.CANDIDATE,to:t})},E.prototype.ewb_create=function(){this.sendMsg(u.SignalType.EWB_CREATE,null,{key:this.channelId})},E.prototype.ewb_query=function(){this.sendMsg(u.SignalType.EWB_QUERY,null,{key:this.channelId})},E.prototype.flowSubscribe=function(e){this.sendMsg(u.SignalType.FLOWSUBSCRIBE,e,{key:this.channelId})},E.prototype.changeMicPhone=function(e){this.localStream.getAudioTracks().forEach(function(t){t.enabled=e})},E.prototype.changeVideo=function(e){this.localStream.getVideoTracks().forEach(function(t){t.enabled=e})};/**
  * 处理channelAnswer通知信令
  *
  */var T={1:function(e){// 邀请观察者发言同意后收到通知
console.error(e),S.rongRTCEngineEventHandle.call("onBecomeUser",{userId:e.parameters.from,userType:1})},2:function(e){console.error(e);var t=e.parameters.serverData,n=e.parameters.status;1==n&&t==S.selfUserId?(console.error("fffffffffffffffffffffffff"),S.rongRTCMeeting.observerBecomeUser(t)):S.rongRTCEngineEventHandle.call("onBecomeUser",{userId:t})},3:function(e){//邀请打开设备
S.rongRTCEngineEventHandle.call("onUserAgreeOpen",{userId:e.parameters.from,type:e.parameters.type,userType:1,status:e.parameters.status})},4:function(e){// 将与会人降级为观察者
S.remoteStreams=S.remoteStreams.filter(function(t){return t.id!=e.parameters.from}),S.rongRTCEngineEventHandle.call("onUserDown",{userId:e.parameters.from,userType:1})},5:function(e){//邀请关闭设备
S.rongRTCEngineEventHandle.call("onUserLeft5",{userId:e.to,userType:1})},other:function(e){console.warn("no handler to handle data",e)}};E.prototype.closeStream=function(e){e?e.getTracks().forEach(function(e){e.stop()}):console.error(" stream is not exist")},E.prototype.getPeerConnection=function(e){var t=this.peerConnections[e],n=t.pc;if(!n)throw new Error("userId => peerConnection is not exist",e);return n};var h=function(){};h.prototype.turntalktype=function(e){var t=e.parameters.type,n=e.parameters.index,r=e.parameters.serverData,a=S.getRemoteStream(r);1==n&&1==t&&a.getVideoTracks().forEach(function(e){e.enabled=!0}),S.rongRTCEngineEventHandle.call("onTurnTalkType",{userId:e.parameters.serverData,type:t,open:!(1!=n)})},h.prototype.channelAnswer=function(e){var t=e.parameters.index||"other",n=T[t];n(e)};var R={1:function(e){//收到观察者主动要求发言
var t=e.parameters.from;S.rongRTCEngineEventHandle.call("OnReciveRequestToUser",{userId:t})},2:function(e){//获取主持人权限响应
S.rongRTCEngineEventHandle.call("OnOtherUserBecomeHost",{hostId:e.parameters.from})},other:function(e){console.warn("no handler to handle data",e)}/**
    * 处理apply通知信令
    *
    */};h.prototype.applyMessage=function(e){var t=e.parameters.index,n=e.parameters.to,r=R[t];r(e)},h.prototype.roleChange=function(e){var t=e.parameters.index,n=e.parameters.to;t==u.Meeting.RoleChange.DEMOTION?this.noramlUserDoHostRequestDegradeNormalUserToObserver(n,!0):t==u.Meeting.RoleChange.INVITE?S.rongRTCEngineEventHandle.call("onBeRequestToUser",{hostId:e.parameters.to}):t==u.Meeting.RoleChange.REMOVE&&n==S.selfUserId&&S.rongRTCEngineEventHandle.call("onHostRemoved",{userId:n})},h.prototype.observerRequestBecomeNormalUser=function(){S.sendMsg(u.SignalType.APPLY,null,{key:S.channelId,index:1})},h.prototype.hostDoObserverRequestBecomeNormalUser=function(e,t){S.sendMsg(u.SignalType.CHANNELANSWER,null,{key:S.channelId,to:e,index:2,status:t})},h.prototype.hostRequestNormalUserToObserver=function(e){S.sendMsg(u.SignalType.ROLECHANGE,null,{key:S.channelId,to:e,index:1})},h.prototype.noramlUserDoHostRequestDegradeNormalUserToObserver=function(e){S.sendMsg(u.SignalType.CHANNELANSWER,null,{key:S.channelId,to:e,index:4,status:1}),S.closeStream(S.localStream);var t=S.getPeerConnection(S.selfUserId);t.removeStream(S.localStream),S.createOffer(t,S.selfUserId,!1),S.rongRTCEngineEventHandle.call("onUserDown",{userId:e})};var C={1:function(e){//摄像头
S.changeVideo(e)},2:function(e){//麦克风
S.changeMicPhone(e)}/**
    函数名：UserDoHostRequestControlUserDevice
    参数：strHostId，主持人的用户ID，enumControlAction，操作类型，关闭或者打开，enumControlMediaType，操作的媒体类型，bAccept，是否同意打开音、视频或者音视频
    返回值：
    说明：用户通过该接口处理主持人打开或关闭音视频的开关进行请求或者观察者处理主持人邀请发言
    */};h.prototype.userDoHostRequestControlUserDevice=function(e,t,n,r){var a=t?3:5,n=n,o=C[n];o(t),S.sendMsg(u.SignalType.CHANNELANSWER,null,{key:S.channelId,to:e,index:a,type:n,status:r})},h.prototype.hostUpUser=function(e){S.sendMsg(u.SignalType.ROLECHANGE,null,{key:S.channelId,to:e,index:2})},h.prototype.observerBecomeUser=function(){var e=S;S.getLocalStreamFromRtcApi(S.mediaConfig).then(function(t){S.localStream=t;var n=S.getPeerConnection(S.selfUserId);if(n.addStream(t),S.createOffer(n,S.selfUserId,!1),N.refreshMediaStream(S.selfUserId),S.rongRTCEngineEventHandle.call("onBecomeUser",{userId:S.selfUserId,stream:S.localStream}),!e.localVideoEnable&&e.microphoneEnable);else if(e.localVideoEnable&&e.microphoneEnable);else if(e.localVideoEnable&&!e.microphoneEnable);S.localVideoEnable=!0,S.microphoneEnable=!0,S.rongRTCEngineEventHandle.call("onaddstream",{userId:S.selfUserId,stream:S.localStream,userType:u.UserType.NORMAL,talkType:1,//升级后音视频默认都开
isLocal:!1})})},h.prototype.doHostRequestToUser=function(e,t){var n=1==t?1:2==t?2:2;1==n&&this.observerBecomeUser(this.selfUserId),S.sendMsg(u.SignalType.CHANNELANSWER,null,{key:S.channelId,to:e,index:1,status:n})},h.prototype.hostRemoveUser=function(e){S.sendMsg(u.SignalType.ROLECHANGE,null,{key:S.channelId,to:e,index:3})},h.prototype.screenShare=function(e){var e=!0==e?1:2;S.sendMsg(u.SignalType.SCREENSHARING,null,{key:S.channelId,index:e})};var I={1:function(e){//收到邀请打开
S.rongRTCEngineEventHandle.call("OnHostRequestControlDevice",{userId:e.parameters.to,content:e.parameters})},2:function(e){//收到邀请打开
S.rongRTCEngineEventHandle.call("OnHostRequestControlDevice",{userId:e.parameters.to,content:e.parameters})},other:function(e){console.warn("no handler to handle data",e)}/**
    * 处理apply通知信令
    *
    */};h.prototype.manageAction=function(e){var t=e.parameters.index,n=e.parameters.to,r=I[t];r(e)},h.prototype.hostRequestControlUserDevice=function(e,t,n){S.sendMsg(u.SignalType.MANAGEACTION,null,{key:S.channelId,to:e,index:n,type:t})},h.prototype.getHostPower=function(){S.sendMsg(u.SignalType.APPLY,null,{key:S.channelId,index:2})},h.prototype.GetInviteUrl=function(){},E.prototype.myBrowser=function(){var e=navigator.userAgent,t=-1<e.indexOf("Opera");//取得浏览器的userAgent字符串
return t?"Opera":-1<e.indexOf("Firefox")?"FF":-1<e.indexOf("Chrome")?"Chrome":-1<e.indexOf("Safari")?"Safari":-1<e.indexOf("compatible")&&-1<e.indexOf("MSIE")&&!t?"IE":void 0;//判断是否Firefox浏览器
//判断是否Safari浏览器
},E.prototype.shareWithStream=function(e){//todo bug 加入前根据麦克风状态静音
this.rongRTCMeeting.screenShare(!0),S.getLocalStreamFromRtcApi({video:!1,audio:!0}).then(function(t){S.localAudioStream=t,t.getAudioTracks().forEach(function(e){e.enabled=S.microphoneEnable}),e.getVideoTracks()[0].onended=function(){S.endShareScreen()},S.screenSharingStatus=!0,S.screenOffer(e)}).catch(function(e){_.error(e)})},E.prototype.logonAndJoin_result=function(e){var t=e.parameters.statusCode,n=!("OK"!=t);if(n){var r=e.content,a=r.split("],"),o=1<a.length?a[1]:a[0],s=JSON.parse(o);// 返回的结果是包含自己的
for(var d in s){var l=s[d].userId;if(!this.joinedUsers.contains(l)){var p=s[d].type,c=s[d].talktype,g=[];g.push(p),g.push(c),g.push(null),this.joinedUsers.put(l,g)}}// 开始keepAlive
if(this.startScheduleKeepAlive(),this.logonAndJoinStatus==u.LogonAndJoinStatus.RECONNECT){// 断线重连，主动发offer
var S=this.peerConnections[this.selfUserId];if(null!=S){// 只有一人时，值为null
var m=S.pc;_.warn("reLogonAndJoin createOffer"),this.createOffer(m,this.selfUserId,!0)}}}var g=this.joinedUsers.get(this.selfUserId),c=g[1];this.logonAndJoinStatus!=u.LogonAndJoinStatus.CONNECT// 正常加入
&&(this.logonAndJoinStatus!=u.LogonAndJoinStatus.RECONNECT||n)// 重连加入且加入失败
&&this.onJoinComplete||(this.rongRTCEngineEventHandle.call("onJoinComplete",{isJoined:n,userId:this.selfUserId,talkType:c}),this.onJoinComplete=!0)},E.prototype.channelPing_result=function(e){this.exitScheduleKeepAliveTimer();var t=e.parameters.statusCode;!("OK"!=t)?this.keepAliveFailedTimes=0:this.keepAliveFailed()},E.prototype.leave_result=function(e){var t=e.parameters.statusCode,n=!("OK"!=t);n&&this.clear(),this.rongRTCEngineEventHandle.call("onLeaveComplete",{isLeft:n})},E.prototype.ewb_create_result=function(e){var t=e.parameters.statusCode,n=!("OK"!=t),r="";n&&(r=e.content),this.rongRTCEngineEventHandle.call("onWhiteBoardURL",{isSuccess:n,url:r// 观察者模式url返回为空
})},E.prototype.ewb_query_result=function(e){var t=e.parameters.statusCode,n=!("OK"!=t),r="";n&&(r=e.content,r?this.ewbCreated=!0:void 0),this.rongRTCEngineEventHandle.call("onWhiteBoardQuery",{isSuccess:n,url:r// 当前会议没有白板url返回为空
})},E.prototype.joined=function(e){var t=e.parameters.serverData,n=e.parameters.type,r=e.parameters.index;if(!this.joinedUsers.contains(t)){var a=[];a.push(n),a.push(r),a.push(null),this.joinedUsers.put(t,a)}//if (userType == RongRTCConstant.UserType.OBSERVER) {
this.rongRTCEngineEventHandle.call("onUserJoined",{// 观察者模式
userId:t,userType:n,talkType:r})},E.prototype.update_talktype=function(e){var t=e.parameters.serverData,n=e.parameters.type,r=e.parameters.index;this.rongRTCEngineEventHandle.call("onUserUpdatedTalkType",{userId:t,userType:n,talkType:r})},E.prototype.turnTalkType=function(e,t,n){this.sendMsg(u.SignalType.TURNTALKTYPE,null,{key:this.channelId,serverdata:e,index:t,type:n})},E.prototype.left=function(e){var t=e.parameters.serverData,n=e.parameters.type;this.joinedUsers.remove(t),this.remoteCnameMap.remove(t),this.remoteSdpMap.remove(t),this.remoteStreams=this.remoteStreams.filter(function(e){return e.id!=t}),1==this.joinedUsers.size()&&(this.offerStatus=null,this.closePeerConnection(this.selfUserId)),this.rongRTCEngineEventHandle.call("onUserLeft",{userId:t,userType:n})},E.prototype.preparePeerConnection=function(e){_.info("preparePeerConnection userId="+e);var t=this;if(null==t.peerConnections[e]){var n=new RTCPeerConnection,r=new RTCPeerConnection;// peerConnection创建成功，开始getStatsReport
n.onaddstream=function(e){_.debug("onaddstream",e),t.remoteStreams.push(e.stream);var n=t.joinedUsers.get(e.stream.id);n.splice(2,1,e.stream);var r=n[1];console.log("talkType",r),(0==r||3==r)&&(console.log("remove Video track",r),e.stream.getVideoTracks().forEach(function(e){e.enabled=!1})),t.rongRTCEngineEventHandle.call("onaddstream",{//
userId:e.stream.id,userType:u.UserType.NORMAL,talkType:r,stream:e.stream,isLocal:!1})},n.onremovestream=function(e){_.debug("onremovestream",e)},n.ontrack=null,n.onsignalingstatechange=function(e){_.debug("onsignalingstatechange",e)},n.oniceconnectionstatechange=function(r){_.debug("oniceconnectionstatechange",r),_.warn("pc.iceConnectionState="+n.iceConnectionState),"failed"==n.iceConnectionState&&t.wsConnectionState==u.wsConnectionState.CONNECTED&&(_.warn("oniceconnectionstatechange createOffer"),t.createOffer(n,e,!0))},n.onnegotiationneeded=null,n.ondatachannel=null,n.onicecandidate=function(r){function a(n,r){return"stable"==(n.signalingState||n.readyState)&&!0==t.peerConnections[e].rem?void(r.candidate&&t.candidate(JSON.stringify(r.candidate),e)):void setTimeout(function(){a(n,r)},2000)}_.debug("onicecandidate",r),a(n,r)},t.peerConnections[e]={},t.peerConnections[e].pc=n,t.peerConnections[e].pcMin=r,t.peerConnections[e].rem=!1,t.startScheduleGetStatsReport()}return t.peerConnections[e]},E.prototype.closePeerConnection=function(e){// 重置带宽设置计数器
// peerConnection关闭，停止getStatsReport
null!=this.peerConnections[e]&&(this.peerConnections[e].pc.close(),this.peerConnections[e]=null),g.bandWidthCount=0,this.exitScheduleGetStatsReport()},E.prototype.offerRequest=function(e){var t=e.parameters.serverData,n=this.preparePeerConnection(t),r=n.pc;if(this.userType==u.UserType.NORMAL&&(r.addStream(this.localStream),S.screenSharingStatus&&r.addStream(this.localAudioStream)),e.parameters.type&&"2"==e.parameters.type&&this.userType==u.UserType.NORMAL);_.warn("offerRequest createOffer"),this.createOffer(r,t,!1)},E.prototype.exchange=function(e){var t=e.parameters.type;t==u.ExchangeType.OFFER?this.handleOffer(e):t==u.ExchangeType.ANSWER?this.handleAnswer(e):t==u.ExchangeType.CANDIDATE&&this.handleCandidate(e)},E.prototype.ewbCreateNotify=function(){this.ewbCreated=!0},E.prototype.handleOffer=function(e){if(this.offerStatus==u.OfferStatus.SENDING)return void _.warn("handleOffer offerStatus sending");var t=e.parameters.from,n=JSON.parse(e.content.replace(/'/g,"\""));n.sdp=N.setBandWidth(n.sdp,this.getBandWidth());var r=this.preparePeerConnection(t),a=r.pc;this.userType==u.UserType.NORMAL&&a.addStream(this.localStream);var o=this;a.setRemoteDescription(new RTCSessionDescription(n),function(){// set remote cname map
_.info("handleOffer setRemoteDescription success"),o.offerStatus=u.OfferStatus.DONE,o.setRemoteCnameMap(n.sdp),r.rem=!0,a.createAnswer(function(e){_.info("createAnswer success"),a.setLocalDescription(e,function(){_.info("createAnswer setLocalDescription success"),o.answer(JSON.stringify(e),t)},function(e){_.error("createAnswer setLocalDescription error: ",e)})},function(e){_.error("createAnswer error: ",e)},o.getSdpMediaConstraints(!1))},function(e){_.error("handleOffer setRemoteDescription error: ",e)})},E.prototype.handleAnswer=function(e){if(this.offerStatus==u.OfferStatus.DONE)return void _.warn("handleAnswer offerStatus done");var t,n=e.parameters.from,r=JSON.parse(e.content.replace(/'/g,"\"")),a=this.preparePeerConnection(n);t=a.pc,r.sdp=N.setBandWidth(r.sdp,this.getBandWidth());var o=this;t.setRemoteDescription(new RTCSessionDescription(r),function(){// set remote cname map
_.info("handleAnswer setRemoteDescription success"),o.offerStatus=u.OfferStatus.DONE,o.setRemoteCnameMap(r.sdp),a.rem=!0},function(e){_.error("handleAnswer setRemoteDescription error: ",e)})},E.prototype.handleCandidate=function(e){var t=e.parameters.from,n=JSON.parse(e.content.replace(/'/g,"\"")),r=this.preparePeerConnection(t),a=r.pc;a.addIceCandidate(new RTCIceCandidate(n),function(){_.info("addIceCandidate success")},function(e){_.error("addIceCandidate error: ",e)})},E.prototype.createOffer=function(e,t,n){if(this.offerStatus==u.OfferStatus.SENDING)return void _.warn("createOffer offerStatus sending");_.info("createOffer userId="+t);var r=this;e.createOffer(function(n){// change streamId use userId
// 替换video参数
_.info("createOffer success"),n.sdp=N.changeStreamId(n.sdp,r.localStream.id,r.selfUserId),r.minStream&&!r.screenSharingStatus&&(n.sdp=N.changeStreamId(n.sdp,r.localStreamMin.id,r.selfUserId+"_tiny")),r.screenSharingStatus&&S.localAudioStream&&(n.sdp=N.changeStreamId(n.sdp,r.localAudioStream.id,r.selfUserId)),n.sdp=N.changeVideoDesc(n.sdp),e.setLocalDescription(n,function(){_.info("createOffer setLocalDescription success"),r.offerStatus=u.OfferStatus.SENDING,r.offer(JSON.stringify(n),t)},function(e){_.error("createOffer setLocalDescription error: ",e)})},function(e){_.error("createOffer error: ",e)},r.getSdpMediaConstraints(n))},E.prototype.getSdpMediaConstraints=function(e){//	if (this.userType == RongRTCConstant.UserType.OBSERVER) { // 观察者模式
//		if (this.mediaConfig.sdpConstraints == null) {
//			this.mediaConfig.sdpConstraints = {};
//		}
//		if (this.mediaConfig.sdpConstraints.mandatory == null) {
//			this.mediaConfig.sdpConstraints.mandatory = {};
//		}
//		this.mediaConfig.sdpConstraints.mandatory.OfferToReceiveAudio = true;
//		this.mediaConfig.sdpConstraints.mandatory.OfferToReceiveVideo = true;
//	}
var t={};return t.mandatory={},t.mandatory.OfferToReceiveAudio=!0,t.mandatory.OfferToReceiveVideo=!0,_.warn("isIceRestart="+e),t.mandatory.IceRestart=e,t},E.prototype.setRemoteCnameMap=function(e){var t=this.joinedUsers.getEntrys();for(var n in t){var r=t[n].key;if(r!=this.selfUserId)// 不是远端
if(!this.remoteCnameMap.contains(r)){var a=N.getCname(e,r);null!=a&&""!=a&&(this.remoteCnameMap.put(r,a),this.remoteSdpMap.put(r,e))}else{var a=this.remoteCnameMap.get(r);if(null!=a&&""!=a&&!N.isHasCname(e,a)){var o=N.getCname(e,r);null!=o&&""!=o&&(this.remoteCnameMap.put(r,o),N.refreshMediaStream(r))}else if(null!=a&&""!=a&&N.isHasCname(e,a)){var o=N.getCname(e,r);if(a==o){var s=this.remoteSdpMap.get(r),d=N.getSsrc(s,r,a),l=N.getSsrc(e,r,a);d!=l&&N.refreshMediaStream(r)}}}}},E.prototype.getBandWidth=function(){return this.screenSharingStatus?u.BandWidth_ScreenShare_1280_720:this.bandWidth};/** ----- 处理通知信令 ----- */ //
// return RongRTCEngine;
// });
/** ----- RongRTCEngine ----- */ /** ----- RongRTCEngineEventHandle ----- */ // var RongRTCEngineEventHandle = (function() {
/**
  * 构造函数
  *
  */var A=function(){return this.eventHandles={},this};/**
  * 绑定事件
  *
  */A.prototype.on=function(e,t){this.eventHandles[e]=t},A.prototype.call=function(e,t){for(var n in this.eventHandles)if(e===n)return this.eventHandles[e](t);_.info("EventHandle "+e+" do not have defined function")};//
// return RongRTCEngineEventHandle;
// });
/** ----- RongRTCEngineEventHandle ----- */ /** ----- RongRTCConnectionStatsReport ----- */var O=function(){this.statsReportSend={},this.statsReportRecvs=[],this.packetSendLossRate=0};/**
  * parse statsReport
  *
  */O.prototype.parseStatsReport=function(e){var t=this.statsReportSend.packetsSent;t=null==t||""==t?0:t;var n=this.statsReportSend.packetsLost;n=null==n||""==n?0:n;var r=0,a={},o=[];for(var s in e){var d=e[s];if("ssrc"==d.type&&"video"==d.mediaType)if(-1!=d.id.indexOf("recv")){var l={};l.googTrackId=d.googTrackId,l.googCodecName=d.googCodecName,l.googCurrentDelayMs=d.googCurrentDelayMs,l.googDecodeMs=d.googDecodeMs,l.googFrameHeightReceived=d.googFrameHeightReceived,l.googFrameRateDecoded=d.googFrameRateDecoded,l.googFrameRateOutput=d.googFrameRateOutput,l.googFrameRateReceived=d.googFrameRateReceived,l.googFrameWidthReceived=d.googFrameWidthReceived,l.packetsLost=d.packetsLost,l.packetsReceived=d.packetsReceived,o.push(l)}else-1!=d.id.indexOf("send")&&(a.googCodecName=d.googCodecName,a.googAvgEncodeMs=d.googAvgEncodeMs,a.googFrameHeightInput=d.googFrameHeightInput,a.googFrameHeightSent=d.googFrameHeightSent,a.googFrameRateSent=d.googFrameRateSent,a.googFrameWidthInput=d.googFrameWidthInput,a.googFrameWidthSent=d.googFrameWidthSent,a.googFrameRateInput=d.googFrameRateInput,a.packetsLost=d.packetsLost,a.packetsSent=d.packetsSent,null!=a.packetsLost&&""!=a.packetsLost&&null!=a.packetsSent&&""!=a.packetsSent&&0!=a.packetsSent-t&&(r=100*(a.packetsLost-n)/(a.packetsSent-t)))}// 重置
this.statsReportSend=null,this.statsReportRecvs=null,this.packetSendLossRate=0,this.statsReportSend=a,this.statsReportRecvs=o,_.debug("packetSendLossRate="+r),this.packetSendLossRate=parseInt(r),_.debug("this.packetSendLossRate="+this.packetSendLossRate)};/** ----- RongRTCUtil ---- */var N={/**
     * 获取websocket地址列表
     *
     */getWsUrlList:function(e,t){v({type:"GET",url:e,async:!0,data:{rand:Math.random()},dataType:"JSON",success:function(e){t(e)},error:function(e){throw _.error("request nav error: ",e),e}})},/**
     * SDP设置带宽
     *
     * @param sdp
     * @param bandWidthParam
     * @returns
     */setBandWidth:function(e,t){var n,r=JSON.parse(JSON.stringify(t));0==g.bandWidthCount&&(n=(r.min+r.max)/2),g.bandWidthCount++,0==g.bandWidthCount%2&&++r.min,e=e.replace(/a=mid:video\n/g,"a=mid:video\nb=AS:"+r.max+"\n");// 查找最优先用的视频代码
var a=e.split("\n"),o=N.findLine(a,"m=video");if(null==o)return e;var s=a[o].split(" "),d=s[3],l=N.findLine(a,"a=rtpmap:"+d);if(null==l)return e;var p="a=fmtp:"+d+" x-google-min-bitrate="+r.min+"; x-google-max-bitrate="+r.max;return null!=n&&(p+="; x-google-start-bitrate="+n),a[l]=a[l].concat("\n"+p),a.join("\n")},/**
     * SDP修改stream id
     *
     * @param sdp
     * @param oldId
     * @param newId
     * @returns
     */changeStreamId:function(e,t,n){return e=e.replace(new RegExp(t,"g"),n),e},/**
     * SDP修改video兼容参数
     *
     * @param sdp
     * @returns
     */changeVideoDesc:function(e){//		var videoDesc1 = "m=video 9 RTP/AVPF 98 96 100 127 125 97 99 101";
//		var videoDesc2 = "a=rtpmap:96 VP8/90000\r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack\r\na=rtcp-fb:96 nack pli\r\na=rtcp-fb:96 goog-remb\r\na=rtcp-fb:96 transport-cc\r\na=rtpmap:98 H264/90000\r\na=rtcp-fb:98 ccm fir\r\na=rtcp-fb:98 nack\r\na=rtcp-fb:98 nack pli\r\na=rtcp-fb:98 goog-remb\r\na=rtcp-fb:98 transport-cc\r\na=fmtp:98 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtpmap:100 red/90000\r\na=rtpmap:127 ulpfec/90000\r\na=rtpmap:125 flexfec-03/90000\r\na=rtcp-fb:125 transport-cc\r\na=rtcp-fb:125 goog-remb\r\na=fmtp:125 repair-window=10000000\r\na=rtpmap:97 rtx/90000\r\na=fmtp:97 apt=96\r\na=rtpmap:99 rtx/90000\r\na=fmtp:99 apt=98\r\na=rtpmap:101 rtx/90000\r\na=fmtp:101 apt=100";
//
//		var findStr1 = "m=video";
//		var findStr2 = "a=rtcp-rsize";
//		var findStr3 = "a=ssrc-group";
//
//		var sdpArr = sdp.split('\r\n');
//		// 查找videoDesc1
//		var findIndex1 = RongRTCUtil.findLine(sdpArr, findStr1);
//		// 替换videoDesc1
//		sdpArr[findIndex1] = videoDesc1;
//		// 查找videoDesc2
//		var findIndex2 = RongRTCUtil.findLine(sdpArr, findStr2);
//		var findIndex3 = RongRTCUtil.findLine(sdpArr, findStr3);
//		// 删除中间的元素
//		sdpArr.splice(findIndex2 + 1, findIndex3 - findIndex2 - 1);
//		// 替换videoDesc2
//		sdpArr[findIndex2] = sdpArr[findIndex2].concat('\r\n' + videoDesc2);
//		return sdpArr.join('\r\n');
var t=e.split("\r\n"),n=N.findLine(t,"m=video");if(null==n)return e;var r=" ",a=t[n].split(r),o=a[0]+r+a[1]+r+a[2],s=N.findLineInRange(t,"a=rtpmap",n+1,t.length-1),d=N.findLineInRange(t,"a=ssrc-group",s+1,t.length-1);null==d&&(d=t.length-1);// 删除中间的元素
var l=t.splice(s,d-s),p=N.findLine(l,"H264/90000"),c=N.findLine(l,"VP8/90000"),g=N.findLine(l,"red/90000"),u=N.findLine(l,"ulpfec/90000"),S=N.findLine(l,"flexfec-03/90000"),m="";// 查找H264
return null!=p&&(o+=r+"98",m+="\r\n"+"a=rtpmap:98 H264/90000\r\na=rtcp-fb:98 ccm fir\r\na=rtcp-fb:98 nack\r\na=rtcp-fb:98 nack pli\r\na=rtcp-fb:98 goog-remb\r\na=rtcp-fb:98 transport-cc\r\na=fmtp:98 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtpmap:99 rtx/90000\r\na=fmtp:99 apt=98"),null!=c&&(o+=r+"96",m+="\r\n"+"a=rtpmap:96 VP8/90000\r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack\r\na=rtcp-fb:96 nack pli\r\na=rtcp-fb:96 goog-remb\r\na=rtcp-fb:96 transport-cc\r\na=rtpmap:97 rtx/90000\r\na=fmtp:97 apt=96"),null!=g&&(o+=r+"100",m+="\r\n"+"a=rtpmap:100 red/90000\r\na=rtpmap:101 rtx/90000\r\na=fmtp:101 apt=100"),null!=u&&(o+=r+"127",m+="\r\n"+"a=rtpmap:127 ulpfec/90000"),null!=S&&(o+=r+"125",m+="\r\n"+"a=rtpmap:125 flexfec-03/90000\r\na=rtcp-fb:125 transport-cc\r\na=rtcp-fb:125 goog-remb\r\na=fmtp:125 repair-window=10000000"),null!=p&&(o+=r+"99"),null!=c&&(o+=r+"97"),null!=g&&(o+=r+"101"),t[n]=o,t[s-1]=t[s-1].concat(m),t.join("\r\n")},/**
     * get cname
     *
     * @param userId
     */getCname:function(e,t){var n=e.split("\n"),r=N.findLine(n,"msid:"+t);if(null==r)return null;var a=n[r].split(" ")[0],o=N.findLine(n,a+" cname:"),s=n[o].split("cname:")[1];// a=ssrc:702269835 cname:wRow2WLrs18ZB3Dg
return s},/**
     * check cname
     *
     * @param userId
     */isHasCname:function(e,t){var n=e.split("\n"),r=N.findLine(n,"cname:"+t);return null!=r},getSsrc:function(e,t,n){//ssrc变化则为屏幕共享
var r=e.split("\n"),a=r.map(function(e,t){if(-1<e.indexOf("mid:video"))return t}).filter(function(e){return e});r=r.slice(a[0]);var o=r.filter(function(e){return-1<e.indexOf("a=ssrc:")}),s=o.map(function(e,t){if(-1<e.indexOf("cname:"+n))return t}).filter(function(e){return e}),d=o.slice(s[0]+1,s[0]+2);return d[0].split(" ")[2]},/**
     * 数组中查找
     *
     * @param arr
     * @param substr
     * @returns
     */findLine:function(e,t){for(var n=0;n<e.length;n++)if(-1!=e[n].indexOf(t))return n;return null},/**
     * 数组中查找
     *
     * @param arr
     * @param substr
     * @param startIndex
     * @param endIndex
     * @returns
     */findLineInRange:function(e,t,n,r){var a=null==n||""==n||0>n?0:n,o=null==r||""==r||0>r||r>e.length-1?e.length-1:r;a=a>o?o:a;for(var s=a;s<=o;s++)if(-1!=e[s].indexOf(t))return s;return null},/**
     * 随机打乱数组内排序
     *
     * @param input
     * @returns
     */shuffle:function(e){for(var t=e.length-1;0<=t;t--){var n=Math.floor(Math.random()*(t+1)),r=e[n];e[n]=e[t],e[t]=r}return e},/**
     * 刷新VideoView的视频流
     *
     * @param userId
     */refreshMediaStream:function(e){var t=document.getElementById(e);if(null!=t){var n=e==S.selfUserId?S.localStream:S.remoteStreams.filter(function(t){return t.id==e})[0];t.srcObject=n,t.srcObject=t.srcObject}},/**
     * 设置VideoView的视频流为指定流
     *
     * @param userId
     */setMediaStream:function(e,t){var n=document.getElementById(e);null!=n&&(n.srcObject=t)},/**
     * 当前浏览器
     */myBrowser:function(){var e=navigator.userAgent,t=-1<e.indexOf("Opera");// 取得浏览器的userAgent字符串
return t?"Opera":-1<e.indexOf("Firefox")?"FF":-1<e.indexOf("Chrome")?"Chrome":-1<e.indexOf("Safari")?"Safari":-1<e.indexOf("compatible")&&-1<e.indexOf("MSIE")&&!t?"IE":void 0;// 判断是否Firefox浏览器
// 判断是否Safari浏览器
}/** ----- RongRTCAjax ----- */},v=function(e){// 初始化数据
function t(e){var t={url:"",type:"GET",data:{},async:!0,dataType:"JSON",success:function(){},error:function(){// alert('status:' + s + 'error!');
}};return e.url=e.url||t.url,e.type=e.type.toUpperCase()||t.method,e.data=r(e.data)||r(t.data),e.dataType=e.dataType.toUpperCase()||t.dataType,e.success=e.success||t.success,e.error=e.error||t.error,e}// 创建XMLHttpRequest对象
function n(){if(window.XMLHttpRequest)// IE7+、Firefox、Opera、Chrome、Safari
return new XMLHttpRequest;if(window.ActiveXObject)// IE6 及以下
for(var e=["MSXML2.XMLHttp","Microsoft.XMLHTTP"],t=0,n=e.length;t<n;t++)try{return new ActiveXObject(version[t])}catch(t){// 跳过
}else throw new Error("\u6D4F\u89C8\u5668\u4E0D\u652F\u6301XHR\u5BF9\u8C61\uFF01")}function r(e){var t=[];for(var n in e)// 特殊字符传参产生的问题可以使用encodeURIComponent()进行编码处理
t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function a(e,t){if(4==t.readyState&&200==t.status){// 判断http的交互是否成功，200表示成功
var n;switch(e.dataType){case"XML":n=t.responseXML;break;case"JSON":var r=t.responseText;r&&(n=JSON.parse(r));break;default:n=t.responseText;}n&&e.success(n)}else// alert('获取数据错误！错误代号：' + xhr.status + '，错误信息：' +
// xhr.statusText);
e.error(t)}// post方法
e.type=e.type.toUpperCase()||"POST","POST"===e.type?function(e){var r=n(),e=t(e);// 创建XHR对象
// 在使用XHR对象时，必须先调用open()方法，
// 它接受三个参数：请求类型(get、post)、请求的URL和表示是否异步。
// post方式需要自己设置http的请求头，来模仿表单提交。
// 放在open方法之后，send方法之前。
e.type="post",!0===e.async&&(r.onreadystatechange=function(){4==r.readyState&&a(e,r)}),r.open(e.type,e.url,e.async),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.send(e.data),!1===e.async&&a(e,r)}// get方法
(e):function(e){var r=n(),e=t(e);// 创建XHR对象
// 若是GET请求，则将数据加到url后面
// 在使用XHR对象时，必须先调用open()方法，
// 它接受三个参数：请求类型(get、post)、请求的URL和表示是否异步。
e.type="get",!0===e.async&&(r.onreadystatechange=function(){4==r.readyState&&a(e,r)}),e.url+=-1==e.url.indexOf("?")?"?"+e.data:"&"+e.data,r.open(e.type,e.url,e.async),r.send(null),!1===e.async&&a(e,r)}(e)},L=function(){this._entrys=[],this.put=function(e,t){if(null!=e&&null!=e){var n=this._getIndex(e);if(-1==n){var r={};r.key=e,r.value=t,this._entrys[this._entrys.length]=r}else this._entrys[n].value=t}},this.get=function(e){var t=this._getIndex(e);return-1==t?null:this._entrys[t].value},this.remove=function(e){var t=this._getIndex(e);-1!=t&&this._entrys.splice(t,1)},this.clear=function(){this._entrys.length=0},this.contains=function(e){var t=this._getIndex(e);return-1!=t},this.size=function(){return this._entrys.length},this.getEntrys=function(){return this._entrys},this._getIndex=function(e){if(null==e||e==null)return-1;for(var t,n=this._entrys.length,r=0;r<n;r++)if((t=this._entrys[r],null!=t&&null!=t)&&t.key===e)// equal
return r;return-1}},_={/**
     * debug
     *
     */debug:function(e,t){console.debug(new Date+" DEBUG "+e),null!=t&&t!=null&&console.debug(t)},/**
     * info
     *
     */info:function(e,t){console.info(new Date+" INFO "+e),null!=t&&t!=null&&console.info(t)},/**
     * log
     *
     */log:function(e,t){console.log(new Date+" LOG "+e),null!=t&&t!=null&&console.log(t)},/**
     * warn
     *
     */warn:function(e,t){console.warn(new Date+" WARN "+e),null!=t&&t!=null&&console.warn(t)},/**
     * error
     *
     */error:function(e,t){console.error(new Date+" ERROR "+e),null!=t&&t!=null&&console.error(t)}},k={},M=function(){function e(){d(this,e)}return l(e,[{key:"on",value:function(e,t){k[e]=t}},{key:"emit",value:function(e,t){c.extend(t,{type:e});var n=k[e]||c.noop;n(t)}}]),e}(),U={url:"https://rtcapi.ronghub.com/nav/websocketlist"},b=null,w=null,D=null,V=function(){function e(t){d(this,e),c.extend(U,t),b=new E(U.url),w=new A,b.setRongRTCEngineEventHandle(w),D=new M}return l(e,[{key:"joinRoom",value:function(e){return c.deferred(function(){console.log(e)})}},{key:"leaveRoom",value:function(e){console.log(e)}},{key:"getStream",value:function(e){console.log(e)}},{key:"mute",value:function(e){console.log(e)}},{key:"unmute",value:function(e){console.log(e)}},{key:"disableVideo",value:function(e){console.log(e)}},{key:"enableVideo",value:function(e){console.log(e)}},{key:"createWhiteBoard",value:function(){console.log(user)}},{key:"getWhiteBoardList",value:function(){console.log(user)}},{key:"startScreenShare",value:function(){}},{key:"stopScreenShare",value:function(){}},{key:"_on",value:function(e,t){D.on(e,t)}}]),e}();return function t(n){d(this,t);var s=new V(n);c.extend(this,{$room:e(s),$stream:r(s),$whiteBoard:a(s),$screenShare:o(s)})}});
